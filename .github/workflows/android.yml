name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.3)'
        required: true
        default: '1.2.3'
        type: string

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 tag 和 release
      actions: read
      checks: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史以便版本计算

    - name: set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build -x lint

    # 确定版本号
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # 使用手动输入的版本
          VERSION="${{ github.event.inputs.version }}"
        else
          # 自动生成版本：日期+短提交hash
          VERSION="1.2.3-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using version: $VERSION"

    # 创建 tag
    - name: Create and push tag
      if: github.event_name == 'workflow_dispatch'  # 只有手动触发时创建 tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 检查 tag 是否已存在
        if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
          echo "Tag v${{ env.VERSION }} already exists"
        else
          # 创建新的 tag
          git tag -a "v${{ env.VERSION }}" -m "Release version ${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"
          echo "Created and pushed tag v${{ env.VERSION }}"
        fi

    # 自动生成版本号文件
    - name: Generate version info
      run: |
        mkdir -p build-info
        cat > build-info/version.txt << EOF
        Version: ${{ env.VERSION }}
        Build Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        Triggered by: ${{ github.actor }}
        EOF

    # 创建 Release
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'  # 只有手动触发时创建 release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }}
        body: |
          ## Release v${{ env.VERSION }}
          
          ### Build Information
          - **Build Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          
          ### Changes in this release
          ${{ github.event.head_commit.message }}
          
          ### Downloads
          - Debug APK: For testing purposes
          - Release APK: For production use
          
          ### Installation Instructions
          1. Download the appropriate APK file
          2. Enable "Install from unknown sources" in your device settings
          3. Open the downloaded APK file to install
          
          ### Notes
          - Minimum SDK: Check your app's requirements
          - Target SDK: Android 14 (API 34)
        files: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/apk/release/*.apk
          build-info/version.txt
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 即使不是正式发布，也上传到 Artifacts
    - name: Upload APK to Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-apk-${{ env.VERSION }}
        path: |
          app/build/outputs/apk/**/*.apk
          build-info/version.txt
        retention-days: 30